<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Adventures With Docker Multistage Build | Still Learning</title><meta name=keywords content="docker,dev-ops"><meta name=description content="fascinating world of docker multi stage builds.."><meta name=author content="Vibhakar &#34;Gala&#34; Solanki"><link rel=canonical href=https://stilllearning.tech/blog/adventures-with-docker-multistage-build/><link crossorigin=anonymous href=/assets/css/stylesheet.b81af9c3b21c6fc25a8deffa023e29895d23615338885069e17e2cee96ab8f74.css integrity="sha256-uBr5w7Icb8Jaje/6Aj4piV0jYVM4iFBp4X4s7parj3Q=" rel="preload stylesheet" as=style><link rel=icon href=https://stilllearning.tech/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://stilllearning.tech/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://stilllearning.tech/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://stilllearning.tech/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://stilllearning.tech/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css integrity="sha512-Jk4AqjWsdSzSWCSuQTfYRIF84Rq/eV0G2+tu07byYwHcbTGfdmLrHjUSwvzp5HvbiqK4ibmNwdcG49Y5RGYPTg==" crossorigin=anonymous referrerpolicy=no-referrer><meta property="og:title" content="Adventures With Docker Multistage Build"><meta property="og:description" content="fascinating world of docker multi stage builds.."><meta property="og:type" content="article"><meta property="og:url" content="https://stilllearning.tech/blog/adventures-with-docker-multistage-build/"><meta property="og:image" content="https://stilllearning.tech/blog/adventures-with-docker-multistage-build/img/multi_stage_docker_builds.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-07-11T23:54:15+05:30"><meta property="article:modified_time" content="2023-07-11T23:54:15+05:30"><meta property="og:site_name" content="Still Learning"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://stilllearning.tech/blog/adventures-with-docker-multistage-build/img/multi_stage_docker_builds.png"><meta name=twitter:title content="Adventures With Docker Multistage Build"><meta name=twitter:description content="fascinating world of docker multi stage builds.."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://stilllearning.tech/blog/"},{"@type":"ListItem","position":2,"name":"Adventures With Docker Multistage Build","item":"https://stilllearning.tech/blog/adventures-with-docker-multistage-build/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Adventures With Docker Multistage Build","name":"Adventures With Docker Multistage Build","description":"fascinating world of docker multi stage builds..","keywords":["docker","dev-ops"],"articleBody":" I thought damm a lot of users must have uploaded content only to find out that the docker images were taking up all the space,\nThis week I dived into the fascinating world of multi-stage docker build\nThe Problem In https://bfportal.gg i use a relatively simple stack,\n#wagtail (a cms that runs on #django ) + #docker + #tailwind .\nThen one day I woke up to an alert on #datadog that almost all of the disk space on the VPS has been used,\nso I did an image prune and thought the size of the images must be quite big to fill up all the space\nlo and behold it was 2 gigs for each image üíÄ ( no wonder my poor VPS was all full )\nso I went on looking for how to reduce the size of the image.\nit was docker multi-stage builds,\nAt this point i had this good ol‚Äô dockerfile ( Click to expand ) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 # Use an official Python runtime based on Debian 10 \"buster\" as a parent image. FROM python:3.11-slim-buster as dev # Add user that will be used in the container. RUN useradd --create-home wagtail # Port used by this container to serve HTTP. EXPOSE 8000 # Set environment variables. # 1. Force Python stdout and stderr streams to be unbuffered. # 2. Set PORT variable that is used by Gunicorn. This should match \"EXPOSE\" # command. ENV PYTHONUNBUFFERED=1 \\ PORT=8000 \\ PYTHONDONTWRITEBYTECODE=1 \\ PATH=\"${PATH}:/home/wagtail/.local/bin\" \\ USER=\"wagtail\" # Install system packages required by Wagtail and Django. RUN apt-get update --yes --quiet \u0026\u0026 apt-get install --yes --quiet --no-install-recommends \\ build-essential \\ curl \\ libpq-dev \\ libmariadbclient-dev \\ libjpeg62-turbo-dev \\ zlib1g-dev \\ libwebp-dev \\ software-properties-common \\ zip \\ unzip \\ git \\ npm \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* /usr/share/doc /usr/share/man \\ \u0026\u0026 apt-get clean RUN npm install npm@8.18.0 -g \u0026\u0026 \\ npm install n -g \u0026\u0026 \\ n 18.8.0 # Install the application server. RUN pip install \"gunicorn==20.0.4\" # Install the project requirements. COPY requirements.txt / RUN pip install -r /requirements.txt # Use /app folder as a directory where the source code is stored. WORKDIR /app # Set this directory to be owned by the \"wagtail\" user. This Wagtail project # uses SQLite, the folder needs to be owned by the user that # will be writing to the database file. RUN chown wagtail:wagtail /app # Copy the source code of the project into the container. COPY --chown=wagtail:wagtail . . # Use user \"wagtail\" to run the build commands below and the server itself. USER wagtail FROM dev as final RUN python manage.py tailwind install --no-input; RUN python manage.py tailwind build --no-input RUN python manage.py collectstatic --noinput --clear Ugly rht ? ü•≤\nIts basically this\nA traditional dockerfile The Solution So i started with separating the tools from dependencies, there were two clear things that i can separate,\nPython Virtual Environment Node binary So i made two separate images for each\nPython In this project i now use poetry, so if you want a reliable way to install poetry in a docker image, here you go\n1 2 3 4 5 6 7 8 9 10 11 12 13 FROM python:3.11-buster as builder RUN pip install poetry==1.5.1 ENV POETRY_NO_INTERACTION=1 \\ POETRY_VIRTUALENVS_IN_PROJECT=1 \\ POETRY_VIRTUALENVS_CREATE=1 WORKDIR /venv RUN apt-get update --yes --quiet \u0026\u0026 apt-get install --yes --quiet --no-install-recommends git RUN touch README.md COPY [\"pyproject.toml\", \"poetry.lock\", \"./\"] RUN poetry config installer.max-workers 10 RUN poetry install --without dev --no-root --no-cache gave it the name builder so that i can later take advantage of COPY --from=, next up was\nNode 16 17 18 FROM node:latest as node_base RUN echo \"NODE Version:\" \u0026\u0026 node --version RUN echo \"NPM Version:\" \u0026\u0026 npm --version ( PS: why is it so hard to install node in debian images ? making a separate image is sooo much easier )\nNow that we have our base images ready we can take advantage of multistage builds\nThe docker image is then split into two parts :\nDev is for local development and contains npm and tailwind binaries Final is for production an i remove the node_modules folder from it to save space ( Previously we only had final :x )\ndev 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 FROM python:3.11-slim-buster as dev WORKDIR /app RUN useradd --create-home wagtail # Port used by this container to serve HTTP. EXPOSE 8000 # Install system packages required by Wagtail and Django. RUN apt-get update --yes --quiet \u0026\u0026 apt-get install --yes --quiet --no-install-recommends \\ build-essential \\ libpq-dev \\ libmariadbclient-dev \\ libjpeg62-turbo-dev \\ zlib1g-dev \\ libwebp-dev \\ curl \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* # Set environment variables. # 1. Force Python stdout and stderr streams to be unbuffered. # command. ENV PYTHONUNBUFFERED=1 \\ PORT=8000 \\ PYTHONDONTWRITEBYTECODE=1 \\ USER=\"wagtail\" \\ VIRTUAL_ENV=/venv/.venv ENV PATH=\"${VIRTUAL_ENV}/bin:${PATH}:/home/wagtail/.local/bin\" COPY --from=builder ${VIRTUAL_ENV} ${VIRTUAL_ENV} COPY --chown=wagtail:wagtail --from=node_base /usr/local/bin /usr/local/bin COPY --chown=wagtail:wagtail --from=node_base /usr/local/lib/node_modules/npm /usr/local/lib/node_modules/npm COPY ./bfportal ./ RUN chown -R wagtail:wagtail /app USER wagtail RUN npm install the important lines are 46 - 51 , in these line we take full advantage by copying only the things we need üòÅ.\nthen we finally move onto final stage\nFinal 61 62 63 64 FROM dev as final RUN npx tailwindcss -i ./bfportal/static/src/styles.css -o ./bfportal/static/css/bfportal.css --minify RUN python manage.py collectstatic --noinput --clear -i static/src/* Now by using buildx ( docker buildx build --target=final ) one day and a few hours of head-scratching later I was able to bring the size of the image down to just 600MB üòÆ .\nTo my understanding we did this\nA Multi Stage Docker Build now all my CI/CD pipelines for bfportal.gg are super fast\n( it was around 7 mins before, now it‚Äôs \u003c 3 mins ) all thanks to docker ‚ù§Ô∏è\nFurther Optimizations Make use of python-alpine image to have even smaller final image size But Python=\u003eSpeed recommends against it Find better way to write file so that we can have less layers and more caching Conclusion Must use buildx for faster build times and better cache Copy only the final compiled tools from a base image MUST REMOVE node_modules IN THE END All in all I find docker to be a awesome technology :) , Have a good day\nPS : Let me know if you have any ideas how to make it better :), you can find me at discord or twitter (gala_vs)\n","wordCount":"1147","inLanguage":"en","image":"https://stilllearning.tech/blog/adventures-with-docker-multistage-build/img/multi_stage_docker_builds.png","datePublished":"2023-07-11T23:54:15+05:30","dateModified":"2023-07-11T23:54:15+05:30","author":[{"@type":"Person","name":"Vibhakar \"Gala\" Solanki"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://stilllearning.tech/blog/adventures-with-docker-multistage-build/"},"publisher":{"@type":"Organization","name":"Still Learning","logo":{"@type":"ImageObject","url":"https://stilllearning.tech/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://stilllearning.tech/ accesskey=h title="Home (Alt + H)"><img src=https://stilllearning.tech/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://stilllearning.tech/diary/ title=Diary><span>Diary</span></a></li><li><a href=https://stilllearning.tech/blog/ title=Blog><span>Blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://stilllearning.tech/>Home</a>&nbsp;¬ª&nbsp;<a href=https://stilllearning.tech/blog/>Blogs</a></div><h1 class=post-title>Adventures With Docker Multistage Build</h1><div class=post-description>fascinating world of docker multi stage builds..</div><div class=post-meta><span title='2023-07-11 23:54:15 +0530 +0530'>July 11, 2023</span>&nbsp;¬∑&nbsp;6 min&nbsp;¬∑&nbsp;1147 words&nbsp;¬∑&nbsp;Vibhakar "Gala" Solanki&nbsp;|&nbsp;<a href=https://github.com/p0lygun/p0lygun.github.io/tree/main/content/blog/blog/adventures-with-docker-multistage-build.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy srcset="https://stilllearning.tech/img/multi_stage_docker_builds_hu6f36ae5c3eec78ab8bc265d4ef51ccbe_16372317_360x0_resize_box_3.png 360w ,https://stilllearning.tech/img/multi_stage_docker_builds_hu6f36ae5c3eec78ab8bc265d4ef51ccbe_16372317_480x0_resize_box_3.png 480w ,https://stilllearning.tech/img/multi_stage_docker_builds_hu6f36ae5c3eec78ab8bc265d4ef51ccbe_16372317_720x0_resize_box_3.png 720w ,https://stilllearning.tech/img/multi_stage_docker_builds_hu6f36ae5c3eec78ab8bc265d4ef51ccbe_16372317_1080x0_resize_box_3.png 1080w ,https://stilllearning.tech/img/multi_stage_docker_builds_hu6f36ae5c3eec78ab8bc265d4ef51ccbe_16372317_1500x0_resize_box_3.png 1500w ,https://stilllearning.tech/img/multi_stage_docker_builds.png 16158w" sizes="(min-width: 768px) 720px, 100vw" src=https://stilllearning.tech/img/multi_stage_docker_builds.png alt="docker file showcasing multistage build" width=16158 height=7440><p>The difference is clear</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#the-problem>The Problem</a></li><li><a href=#the-solution>The Solution</a><ul><li><a href=#python>Python</a></li><li><a href=#node>Node</a></li><li><a href=#dev>dev</a></li><li><a href=#final>Final</a></li></ul></li><li><a href=#further-optimizations>Further Optimizations</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details></div><div class=post-content><blockquote><p>I thought damm a lot of users must have uploaded content only to find out that the <strong>docker images were taking up all the space</strong>,</p></blockquote><p>This week I dived into the fascinating world of multi-stage docker build</p><h2 id=the-problem>The Problem<a hidden class=anchor aria-hidden=true href=#the-problem>#</a></h2><p>In <a href=https://bfportal.gg target=_blank>https://bfportal.gg</a>
i use a relatively simple stack,</p><p><a href="https://www.linkedin.com/feed/hashtag/?keywords=wagtail&amp;highlightedUpdateUrns=urn%3Ali%3Aactivity%3A7084619263340130304" target=_blank>#wagtail</a>
(a cms that runs on <a href="https://www.linkedin.com/feed/hashtag/?keywords=django&amp;highlightedUpdateUrns=urn%3Ali%3Aactivity%3A7084619263340130304" target=_blank>#django</a>
) + <a href="https://www.linkedin.com/feed/hashtag/?keywords=docker&amp;highlightedUpdateUrns=urn%3Ali%3Aactivity%3A7084619263340130304" target=_blank>#docker</a>
+ <a href="https://www.linkedin.com/feed/hashtag/?keywords=tailwind&amp;highlightedUpdateUrns=urn%3Ali%3Aactivity%3A7084619263340130304" target=_blank>#tailwind</a>
.</p><p>Then one day I woke up to an alert on <a href="https://www.linkedin.com/feed/hashtag/?keywords=datadog&amp;highlightedUpdateUrns=urn%3Ali%3Aactivity%3A7084619263340130304" target=_blank>#datadog</a>
that almost all of the disk space on the VPS has been used,</p><p>so I did an image prune and thought the size of the images must be quite big to fill up all the space</p><p>lo and behold it was 2 gigs for each image üíÄ ( no wonder my poor VPS was all full )</p><p>so I went on looking for how to reduce the size of the image.<br>it was docker multi-stage builds,</p><p><details><summary>At this point i had this good ol&rsquo; dockerfile ( Click to expand )</summary><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># Use an official Python runtime based on Debian 10 &#34;buster&#34; as a parent image.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> python:3.11-slim-buster as dev</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Add user that will be used in the container.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> useradd --create-home wagtail<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Port used by this container to serve HTTP.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8000</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Set environment variables.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 1. Force Python stdout and stderr streams to be unbuffered.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 2. Set PORT variable that is used by Gunicorn. This should match &#34;EXPOSE&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#    command.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>PYTHONUNBUFFERED</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PORT</span><span class=o>=</span><span class=m>8000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PYTHONDONTWRITEBYTECODE</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>PATH</span><span class=si>}</span><span class=s2>:/home/wagtail/.local/bin&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>USER</span><span class=o>=</span><span class=s2>&#34;wagtail&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Install system packages required by Wagtail and Django.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update --yes --quiet <span class=o>&amp;&amp;</span> apt-get install --yes --quiet --no-install-recommends <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    build-essential <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    curl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libpq-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libmariadbclient-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libjpeg62-turbo-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    zlib1g-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libwebp-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    software-properties-common <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    zip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    unzip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    git <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    npm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> rm -rf /var/lib/apt/lists/* /usr/share/doc /usr/share/man <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> apt-get clean<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> npm install npm@8.18.0 -g <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    npm install n -g <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    n 18.8.0<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Install the application server.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install <span class=s2>&#34;gunicorn==20.0.4&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Install the project requirements.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt /<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install -r /requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Use /app folder as a directory where the source code is stored.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Set this directory to be owned by the &#34;wagtail&#34; user. This Wagtail project</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># uses SQLite, the folder needs to be owned by the user that</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># will be writing to the database file.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chown wagtail:wagtail /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy the source code of the project into the container.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --chown<span class=o>=</span>wagtail:wagtail . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Use user &#34;wagtail&#34; to run the build commands below and the server itself.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> wagtail</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> dev as final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> python manage.py tailwind install --no-input<span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> python manage.py tailwind build --no-input<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> python manage.py collectstatic --noinput --clear<span class=err>
</span></span></span></code></pre></td></tr></table></div></div></details><br>Ugly rht ? ü•≤<br>Its basically this</p><figure class=align-center><img loading=lazy src=/tradiational_stack.png#center width=50%><figcaption>A traditional dockerfile</figcaption></figure><h2 id=the-solution>The Solution<a hidden class=anchor aria-hidden=true href=#the-solution>#</a></h2><p>So i started with separating the tools from dependencies, there were two clear things that i can separate,</p><ol><li>Python Virtual Environment</li><li>Node binary</li></ol><p>So i made two separate images for each</p><h3 id=python>Python<a hidden class=anchor aria-hidden=true href=#python>#</a></h3><p>In this project i now use <code>poetry</code>, so if you want a reliable way to install poetry in a docker image, here you go</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.11-buster as builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install <span class=nv>poetry</span><span class=o>==</span>1.5.1<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>POETRY_NO_INTERACTION</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>POETRY_VIRTUALENVS_IN_PROJECT</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>POETRY_VIRTUALENVS_CREATE</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /venv</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update --yes --quiet <span class=o>&amp;&amp;</span> apt-get install --yes --quiet --no-install-recommends git<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> touch README.md<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;pyproject.toml&#34;</span>, <span class=s2>&#34;poetry.lock&#34;</span>, <span class=s2>&#34;./&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> poetry config installer.max-workers <span class=m>10</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> poetry install --without dev --no-root --no-cache<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>gave it the name <code>builder</code> so that i can later take advantage of <code>COPY --from=</code>, next up was</p><h3 id=node>Node<a hidden class=anchor aria-hidden=true href=#node>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> node:latest as node_base</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>echo</span> <span class=s2>&#34;NODE Version:&#34;</span> <span class=o>&amp;&amp;</span> node --version<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>echo</span> <span class=s2>&#34;NPM Version:&#34;</span> <span class=o>&amp;&amp;</span> npm --version<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>( PS: why is it so hard to install node in debian images ? making a separate image is sooo much easier )</p><p>Now that we have our base images ready we can take advantage of <code>multistage</code> builds</p><p>The docker image is then split into two parts :</p><ul><li><strong>Dev</strong> is for local development and contains npm and tailwind binaries</li><li><strong>Final</strong> is for production an i remove the <code>node_modules</code> folder from it to save space</li></ul><p>( Previously we only had final :x )</p><h3 id=dev>dev<a hidden class=anchor aria-hidden=true href=#dev>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.11-slim-buster as dev</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> useradd --create-home wagtail<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Port used by this container to serve HTTP.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8000</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Install system packages required by Wagtail and Django.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update --yes --quiet <span class=o>&amp;&amp;</span> apt-get install --yes --quiet --no-install-recommends <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    build-essential <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libpq-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libmariadbclient-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libjpeg62-turbo-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    zlib1g-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libwebp-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    curl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=o>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Set environment variables.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 1. Force Python stdout and stderr streams to be unbuffered.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#    command.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>PYTHONUNBUFFERED</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PORT</span><span class=o>=</span><span class=m>8000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>PYTHONDONTWRITEBYTECODE</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=k>USER</span><span class=s>=&#34;wagtail&#34; \</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nv>VIRTUAL_ENV</span><span class=o>=</span>/venv/.venv<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>VIRTUAL_ENV</span><span class=si>}</span><span class=s2>/bin:</span><span class=si>${</span><span class=nv>PATH</span><span class=si>}</span><span class=s2>:/home/wagtail/.local/bin&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder <span class=si>${</span><span class=nv>VIRTUAL_ENV</span><span class=si>}</span> <span class=si>${</span><span class=nv>VIRTUAL_ENV</span><span class=si>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --chown<span class=o>=</span>wagtail:wagtail --from<span class=o>=</span>node_base /usr/local/bin /usr/local/bin<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --chown<span class=o>=</span>wagtail:wagtail --from<span class=o>=</span>node_base /usr/local/lib/node_modules/npm /usr/local/lib/node_modules/npm<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./bfportal ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chown -R wagtail:wagtail /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> wagtail</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> npm install<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>the important lines are <code>46 - 51</code> , in these line we take full advantage by copying only the things we need üòÅ.</p><p>then we finally move onto <strong>final</strong> stage</p><h3 id=final>Final<a hidden class=anchor aria-hidden=true href=#final>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> dev as final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> npx tailwindcss -i ./bfportal/static/src/styles.css  -o ./bfportal/static/css/bfportal.css --minify<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> python manage.py collectstatic --noinput --clear  -i static/src/*<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>Now by using <code>buildx</code> ( <code>docker buildx build --target=final</code> ) one day and a few hours of head-scratching later I was able to bring the size of the image down to just <strong>600MB</strong> üòÆ .</p><p>To my understanding we did this</p><figure class=align-center><img loading=lazy src=/multi_stage_build.png#center><figcaption>A Multi Stage Docker Build</figcaption></figure><p>now all my CI/CD pipelines for <a href=http://bfportal.gg target=_blank>bfportal.gg</a>
are super fast<br>( it was around 7 mins before, now it&rsquo;s &lt; 3 mins ) all thanks to docker ‚ù§Ô∏è</p><h2 id=further-optimizations>Further Optimizations<a hidden class=anchor aria-hidden=true href=#further-optimizations>#</a></h2><ul><li>Make use of python-alpine image to have even smaller final image size<ul><li>But <a href=https://pythonspeed.com/articles/base-image-python-docker-images/ target=_blank>Python=>Speed</a>
recommends against it</li></ul></li><li>Find better way to write file so that we can have less layers and more caching</li></ul><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><ul><li>Must use <code>buildx</code> for faster build times and better cache</li><li>Copy only the final compiled tools from a base image</li><li>MUST REMOVE <code>node_modules</code> IN THE END</li></ul><p>All in all I find docker to be a awesome technology :) , Have a good day</p><p>PS : Let me know if you have any ideas how to make it better :), you can find me at discord or twitter (gala_vs)</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://stilllearning.tech/tags/docker/>docker</a></li><li><a href=https://stilllearning.tech/tags/dev-ops/>dev-ops</a></li></ul><nav class=paginav><a class=next href=https://stilllearning.tech/blog/hello-world/><span class=title>Next ¬ª</span><br><span>Hello World</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Adventures With Docker Multistage Build on twitter" href="https://twitter.com/intent/tweet/?text=Adventures%20With%20Docker%20Multistage%20Build&amp;url=https%3a%2f%2fstilllearning.tech%2fblog%2fadventures-with-docker-multistage-build%2f&amp;hashtags=docker%2cdev-ops"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Adventures With Docker Multistage Build on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fstilllearning.tech%2fblog%2fadventures-with-docker-multistage-build%2f&amp;title=Adventures%20With%20Docker%20Multistage%20Build&amp;summary=Adventures%20With%20Docker%20Multistage%20Build&amp;source=https%3a%2f%2fstilllearning.tech%2fblog%2fadventures-with-docker-multistage-build%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Adventures With Docker Multistage Build on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fstilllearning.tech%2fblog%2fadventures-with-docker-multistage-build%2f&title=Adventures%20With%20Docker%20Multistage%20Build"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Adventures With Docker Multistage Build on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fstilllearning.tech%2fblog%2fadventures-with-docker-multistage-build%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Adventures With Docker Multistage Build on whatsapp" href="https://api.whatsapp.com/send?text=Adventures%20With%20Docker%20Multistage%20Build%20-%20https%3a%2f%2fstilllearning.tech%2fblog%2fadventures-with-docker-multistage-build%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Adventures With Docker Multistage Build on telegram" href="https://telegram.me/share/url?text=Adventures%20With%20Docker%20Multistage%20Build&amp;url=https%3a%2f%2fstilllearning.tech%2fblog%2fadventures-with-docker-multistage-build%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://stilllearning.tech/>Still Learning</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>